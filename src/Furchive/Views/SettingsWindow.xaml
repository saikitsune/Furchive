<Window x:Class="Furchive.Views.SettingsWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:ui="http://schemas.modernwpf.com/2019"
    Title="Settings" Height="600" Width="720"
    ui:WindowHelper.UseModernWindowStyle="True"
    Background="{DynamicResource SystemControlBackgroundAltHighBrush}">
    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
        <ui:ThemeResources />
        <ui:XamlControlsResources />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Window.Resources>
    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="16">
            <!-- Top actions -->
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,0,8">
                <Button Content="Save" Command="{Binding SaveCommand}" Margin="0,0,8,0"/>
                <Button Content="Close" Click="Close_Click"/>
            </StackPanel>
            <TextBlock Text="Appearance" FontWeight="Bold" Margin="0,0,0,8"/>
            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                <TextBlock Text="Theme:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                <ComboBox Width="160" SelectedIndex="0" SelectionChanged="Theme_SelectionChanged">
                    <ComboBoxItem Content="System"/>
                    <ComboBoxItem Content="Light"/>
                    <ComboBoxItem Content="Dark"/>
                </ComboBox>
            </StackPanel>
            <!-- Gallery Scale moved under Appearance -->
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,0,6">
                <TextBlock Text="Gallery item scale:" VerticalAlignment="Center" Width="160"/>
                <Slider Minimum="0.75" Maximum="1.5" SmallChange="0.05" LargeChange="0.1" Width="200" Value="{Binding GalleryScale, Mode=TwoWay}"/>
                <TextBlock Text="{Binding GalleryScale, StringFormat={}{0:0.00}x}" Margin="8,0,0,0" VerticalAlignment="Center"/>
            </StackPanel>
            <!-- Posts per page under Appearance -->
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,0,12">
                <TextBlock Text="Posts per page:" VerticalAlignment="Center" Width="160"/>
                <TextBox Text="{Binding PostsPerPage, UpdateSourceTrigger=PropertyChanged}" Width="60"/>
                <TextBlock Text="(1-100)" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="Gray"/>
            </StackPanel>

            <Separator/>
            <TextBlock Text="Downloads" FontWeight="Bold" Margin="0,12,0,8"/>
            <StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,0,6">
                    <TextBlock Text="Default Folder:" VerticalAlignment="Center" Width="120"/>
                    <TextBox Text="{Binding DefaultDownloadDirectory, UpdateSourceTrigger=PropertyChanged}" Width="420"/>
                    <Button Content="Browse..." Margin="8,0,0,0" Click="BrowseDownloadFolder_Click"/>
                    <Button Content="Open" Margin="8,0,0,0" Click="OpenDownloadsFolder_Click"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Filename Template:" VerticalAlignment="Center" Width="120"/>
                    <TextBox Text="{Binding FilenameTemplate, UpdateSourceTrigger=PropertyChanged}" Width="420"/>
                </StackPanel>
                <TextBlock FontSize="10" Foreground="Gray" Text="Placeholders: {source}, {artist}, {id}, {safeTitle}, {ext}" Margin="120,2,0,0"/>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,6,0,0">
                    <TextBlock Text="Pool Template:" VerticalAlignment="Center" Width="120"/>
                    <TextBox Text="{Binding PoolFilenameTemplate, UpdateSourceTrigger=PropertyChanged}" Width="420"/>
                </StackPanel>
                <TextBlock FontSize="10" Foreground="Gray" TextWrapping="Wrap" Margin="120,2,0,0"
                           Text="Used only when downloading from a pool. Default: {source}/pools/{artist}/{pool_name}/{page_number}_{id}.{ext}
Placeholders: {source}, {artist}, {id}, {safeTitle}, {ext}, {pool_name}, {page_number}"/>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,6,0,0">
                    <TextBlock Text="Concurrent downloads:" VerticalAlignment="Center" Width="160"/>
                    <TextBox Text="{Binding ConcurrentDownloads, UpdateSourceTrigger=PropertyChanged}" Width="60" Margin="8,0,0,0"/>
                    <TextBlock Text="(1-4 to respect e621 limits)" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="Gray"/>
                </StackPanel>
            </StackPanel>

            <Separator/>
            <TextBlock Text="Authentication" FontWeight="Bold" Margin="0,12,0,8"/>

        <GroupBox Header="e621" Margin="0,0,0,8">
                <StackPanel Margin="8">
            <TextBlock Text="User-Agent (in use)"/>
            <TextBox Text="{Binding ComputedUserAgent, Mode=OneWay}" IsReadOnly="True" IsReadOnlyCaretVisible="True"/>
                    <TextBlock Text="Username" Margin="0,8,0,0"/>
                    <TextBox Text="{Binding E621Username, UpdateSourceTrigger=PropertyChanged}"/>
                    <TextBlock Text="API Key" Margin="0,8,0,0"/>
                    <TextBox Text="{Binding E621ApiKey, UpdateSourceTrigger=PropertyChanged}"/>
                    <Button Content="Test e621" Margin="0,8,0,0" Click="TestE621_Click"/>
                    <TextBlock Margin="0,4,0,0" FontSize="10" Foreground="Gray" TextWrapping="Wrap"
                   Text="User-Agent is set automatically: Furchive/VERSION (by USERNAME or Anon if blank). If using an API key, fill both Username and API key"/>
                </StackPanel>
            </GroupBox>

            <Separator/>
            <TextBlock Text="Viewer" FontWeight="Bold" Margin="0,12,0,8"/>
            <StackPanel>
                <CheckBox Content="Autoplay videos" IsChecked="{Binding VideoAutoplay}"/>
                <CheckBox Content="Start videos muted" IsChecked="{Binding VideoStartMuted}"/>
                <CheckBox Content="Enable GPU acceleration (restart may be required)" IsChecked="{Binding ViewerGpuAccelerationEnabled}"/>
                <TextBlock FontSize="10" Foreground="Gray" TextWrapping="Wrap"
                           Text="Chromium may block autoplay with sound; enabling “Start video muted” ensures autoplay works reliably."/>
            </StackPanel>

            <Separator/>
            <TextBlock Text="Cache" FontWeight="Bold" Margin="0,8,0,8"/>
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="Path:" Margin="0,0,8,0"/>
                <TextBlock Text="{Binding CachePath}"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,4,0,0">
                <TextBlock Text="Used:" Margin="0,0,8,0"/>
                <TextBlock Text="{Binding CacheUsedBytes, Converter={StaticResource BytesToStringConverter}}"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                <Button Content="Refresh" Command="{Binding RefreshCacheInfoCommand}" Margin="0,0,8,0"/>
                <Button Content="Clear Cache" Command="{Binding ClearCacheCommand}" Margin="0,0,8,0"/>
                <Button Content="Open Cache Folder" Click="OpenCacheFolder_Click"/>
            </StackPanel>

            <Separator/>
            <TextBlock Text="Temp" FontWeight="Bold" Margin="0,12,0,8"/>
            <StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Path:" Margin="0,0,8,0"/>
                    <TextBlock Text="{Binding TempPath}"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,4,0,0">
                    <TextBlock Text="Used:" Margin="0,0,8,0"/>
                    <TextBlock Text="{Binding TempUsedBytes, Converter={StaticResource BytesToStringConverter}}"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                    <Button Content="Refresh" Command="{Binding RefreshTempInfoCommand}" Margin="0,0,8,0"/>
                    <Button Content="Clear Temp" Command="{Binding ClearTempCommand}" Margin="0,0,8,0"/>
                    <Button Content="Open Temp Folder" Click="OpenTempFolder_Click"/>
                </StackPanel>
            </StackPanel>

            <Separator/>
            <TextBlock Text="Pools" FontWeight="Bold" Margin="0,12,0,8"/>
            <StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Cache file:" VerticalAlignment="Center" Width="120"/>
                    <TextBlock Text="{Binding PoolsCacheFilePath}"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,4,0,0">
                    <TextBlock Text="Cached pools:" VerticalAlignment="Center" Width="120"/>
                    <TextBlock Text="{Binding PoolsCachedCount}"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,4,0,0">
                    <TextBlock Text="Last cached at:" VerticalAlignment="Center" Width="120"/>
                    <TextBlock Text="{Binding PoolsLastCachedAt, StringFormat={}{0:G}}"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                    <Button Content="Refresh Info" Command="{Binding RefreshPoolsCacheInfoCommand}" Margin="0,0,8,0"/>
                    <Button Content="Recache Pools" Command="{Binding RebuildPoolsCacheCommand}" Margin="0,0,8,0"/>
                    <Button Content="Soft Refresh" Click="SoftRefresh_Click"/>
                </StackPanel>

                <TextBlock FontSize="10" Foreground="Gray" TextWrapping="Wrap" Margin="0,6,0,0">
                    Pools are cached locally for fast lookup. A background incremental update runs periodically.
                    Use Recache Pools to rebuild from scratch. Soft Refresh triggers the incremental update immediately.
                    Pools marked deleted or with no visible posts are excluded.
                </TextBlock>

                <!-- Update interval setting -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,12,0,0">
                    <TextBlock Text="Update every (minutes):" VerticalAlignment="Center" Width="160"/>
                    <TextBox Width="100" Text="{Binding PoolsUpdateIntervalMinutes, UpdateSourceTrigger=PropertyChanged}"/>
                    <TextBlock Text="(min 5)" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="Gray"/>
                </StackPanel>
            </StackPanel>

            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,12,0,0">
                <Button Content="Save" Command="{Binding SaveCommand}" Margin="0,0,8,0"/>
                <Button Content="Close" Click="Close_Click"/>
            </StackPanel>

            <Separator/>
            <TextBlock Text="Search Cache" FontWeight="Bold" Margin="0,12,0,8"/>
            <TextBlock FontSize="10" Foreground="Gray" TextWrapping="Wrap" Margin="0,0,0,6"
                       Text="Advanced: tune e621 search/pool cache TTLs (minutes) and pool-detail fetch concurrency. Changes take effect on next app start."/>
            <StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,4,0,0">
                    <TextBlock Text="Pool detail concurrency:" VerticalAlignment="Center" Width="220"/>
                    <TextBox Width="80" Text="{Binding E621MaxPoolDetailConcurrency, UpdateSourceTrigger=PropertyChanged}"/>
                    <TextBlock Text="(1-16)" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="Gray"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,6,0,0">
                    <TextBlock Text="Prefetch pages ahead:" VerticalAlignment="Center" Width="220"/>
                    <TextBox Width="80" Text="{Binding E621SearchPrefetchPagesAhead, UpdateSourceTrigger=PropertyChanged}"/>
                    <TextBlock Text="(0-5)" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="Gray"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,4,0,0">
                    <TextBlock Text="Prefetch parallelism:" VerticalAlignment="Center" Width="220"/>
                    <TextBox Width="80" Text="{Binding E621SearchPrefetchParallelism, UpdateSourceTrigger=PropertyChanged}"/>
                    <TextBlock Text="(1-4)" VerticalAlignment="Center" Margin="8,0,0,0" Foreground="Gray"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,4,0,0">
                    <TextBlock Text="Search results TTL (min):" VerticalAlignment="Center" Width="220"/>
                    <TextBox Width="80" Text="{Binding E621SearchTtlMinutes, UpdateSourceTrigger=PropertyChanged}"/>
                    <Button Content="Clear" Margin="8,0,0,0" Click="ClearE621SearchCache_Click"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,4,0,0">
                    <TextBlock Text="Tag suggest TTL (min):" VerticalAlignment="Center" Width="220"/>
                    <TextBox Width="80" Text="{Binding E621TagSuggestTtlMinutes, UpdateSourceTrigger=PropertyChanged}"/>
                    <Button Content="Clear" Margin="8,0,0,0" Click="ClearE621TagSuggestCache_Click"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,4,0,0">
                    <TextBlock Text="Pool posts TTL (min):" VerticalAlignment="Center" Width="220"/>
                    <TextBox Width="80" Text="{Binding E621PoolPostsTtlMinutes, UpdateSourceTrigger=PropertyChanged}"/>
                    <Button Content="Clear" Margin="8,0,0,0" Click="ClearE621PoolPostsCache_Click"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,4,0,0">
                    <TextBlock Text="Full pool TTL (min):" VerticalAlignment="Center" Width="220"/>
                    <TextBox Width="80" Text="{Binding E621PoolAllTtlMinutes, UpdateSourceTrigger=PropertyChanged}"/>
                    <Button Content="Clear" Margin="8,0,0,0" Click="ClearE621FullPoolCache_Click"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,4,0,0">
                    <TextBlock Text="Post details TTL (min):" VerticalAlignment="Center" Width="220"/>
                    <TextBox Width="80" Text="{Binding E621PostDetailsTtlMinutes, UpdateSourceTrigger=PropertyChanged}"/>
                    <Button Content="Clear" Margin="8,0,0,0" Click="ClearE621PostDetailsCache_Click"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,4,0,0">
                    <TextBlock Text="Pool metadata TTL (min):" VerticalAlignment="Center" Width="220"/>
                    <TextBox Width="80" Text="{Binding E621PoolsTtlMinutes, UpdateSourceTrigger=PropertyChanged}"/>
                    <Button Content="Clear" Margin="8,0,0,0" Click="ClearE621PoolDetailsCache_Click"/>
                </StackPanel>
            </StackPanel>

            <Separator/>
            <TextBlock Text="Persistent Cache" FontWeight="Bold" Margin="0,12,0,8"/>
            <StackPanel>
                <CheckBox Content="Enable persistent API cache (experimental)" IsChecked="{Binding E621PersistentCacheEnabled}"/>
                <TextBlock FontSize="10" Foreground="Gray" TextWrapping="Wrap" Margin="0,4,0,6"
                           Text="Saves selected e621 API caches to disk on exit and reloads on startup. Entries respect TTLs and caps. Split per cache type for safety."/>
                <UniformGrid Columns="2" Rows="3" Margin="0,4,0,0">
                    <StackPanel Orientation="Horizontal" Margin="0,2,16,2">
                        <TextBlock Text="Search max entries:" Width="180" VerticalAlignment="Center"/>
                        <TextBox Width="80" Text="{Binding E621PersistentCacheMaxSearchEntries, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,2,0,2">
                        <TextBlock Text="Tag suggest max entries:" Width="200" VerticalAlignment="Center"/>
                        <TextBox Width="80" Text="{Binding E621PersistentCacheMaxTagSuggestEntries, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,2,16,2">
                        <TextBlock Text="Pool posts max entries:" Width="180" VerticalAlignment="Center"/>
                        <TextBox Width="80" Text="{Binding E621PersistentCacheMaxPoolPostsEntries, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,2,0,2">
                        <TextBlock Text="Full pool max entries:" Width="200" VerticalAlignment="Center"/>
                        <TextBox Width="80" Text="{Binding E621PersistentCacheMaxFullPoolEntries, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,2,16,2">
                        <TextBlock Text="Post details max entries:" Width="180" VerticalAlignment="Center"/>
                        <TextBox Width="80" Text="{Binding E621PersistentCacheMaxPostDetailsEntries, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,2,0,2">
                        <TextBlock Text="Pool details max entries:" Width="200" VerticalAlignment="Center"/>
                        <TextBox Width="80" Text="{Binding E621PersistentCacheMaxPoolDetailsEntries, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>
                </UniformGrid>
            </StackPanel>
        </StackPanel>
    </ScrollViewer>
</Window>
