<Window x:Class="Furchive.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ui="http://schemas.modernwpf.com/2019"
        xmlns:local="clr-namespace:Furchive.Views"
        ui:WindowHelper.UseModernWindowStyle="True"
        Title="Furchive - Furry Art Gallery Browser" 
    Height="800" Width="1200"
    WindowState="Maximized"
        MinHeight="600" MinWidth="800">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Toolbar -->
            <RowDefinition Height="*"/>    <!-- Main Content -->
            <RowDefinition Height="5"/>    <!-- Splitter -->
            <RowDefinition x:Name="DownloadsRow" Height="200"/>  <!-- Download Queue (resizable) -->
            <RowDefinition Height="Auto"/> <!-- Status Bar -->
        </Grid.RowDefinitions>

        <!-- Toolbar -->
    <ToolBar Grid.Row="0" ToolBarTray.IsLocked="True" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}">
            <StackPanel Orientation="Horizontal">
                <!-- Search -->
                <Label Content="Search:" VerticalAlignment="Center" Margin="5,0"/>
                <TextBox x:Name="searchQuery" Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}" 
                         Width="200" Margin="5,0" KeyDown="SearchQuery_KeyDown"/>
                
                <!-- Rating Filter -->
                <ComboBox x:Name="ratingFilter" Width="160" Margin="5,0" SelectedIndex="{Binding RatingFilterIndex, Mode=TwoWay}">
                    <ComboBoxItem Content="All"/>
                    <ComboBoxItem Content="Explicit"/>
                    <ComboBoxItem Content="Questionable"/>
                    <ComboBoxItem Content="Safe"/>
                </ComboBox>

    <Button x:Name="searchButton" Content="Search" Command="{Binding SearchCommand}" 
                        Style="{StaticResource ToolbarButtonStyle}" IsEnabled="{Binding IsSearching, Converter={StaticResource InverseBooleanConverter}}"/>

    <Button x:Name="favoritesButton" Content="Favorites" Command="{Binding FavoritesCommand}"
        Style="{StaticResource ToolbarButtonStyle}" Margin="6,0,0,0"
        Visibility="{Binding ShowFavoritesButton, Converter={StaticResource BooleanToVisibilityConverter}}"/>

        <!-- Pagination Controls in Toolbar -->
        <Separator Margin="10,0"/>
        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
            <Button Content="◀ Prev" Command="{Binding PrevPageCommand}" Margin="0,0,5,0"
                IsEnabled="{Binding CanGoPrev}" Style="{StaticResource ToolbarButtonStyle}"/>
            <TextBlock Text="{Binding PageInfo}" VerticalAlignment="Center" Margin="0,0,5,0"/>
            <Button Content="Next ▶" Command="{Binding NextPageCommand}" Margin="0,0,5,0"
                IsEnabled="{Binding CanGoNext}" Style="{StaticResource ToolbarButtonStyle}"/>
        </StackPanel>

                <Separator Margin="10,0"/>

                <!-- Download Actions moved to Downloads panel -->

                <Separator Margin="10,0"/>

                <Button x:Name="settingsButton" Content="Settings" Click="SettingsButton_Click"
                        Style="{StaticResource ToolbarButtonStyle}"/>
            </StackPanel>
        </ToolBar>

        <!-- Main Content Area -->
    <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="TagColumn" Width="300"/> <!-- Tag Editor -->
                <ColumnDefinition x:Name="GalleryColumn" Width="*"/>   <!-- Gallery -->
                <ColumnDefinition x:Name="PreviewColumn" Width="350"/> <!-- Preview Pane -->
            </Grid.ColumnDefinitions>

            <!-- Left Column: Pools + Tag Management Panel -->
            <Border Grid.Column="0" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" 
                    BorderBrush="{DynamicResource SystemControlBackgroundBaseMediumBrush}" BorderThickness="0,0,1,0">
                <ScrollViewer Margin="10">
                    <StackPanel>
                        <!-- Pools Section -->
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <TextBlock Text="Pools" Style="{StaticResource SubHeaderTextStyle}"/>
                            <TextBlock Text=" " Width="6"/>
                            <TextBlock Text="{Binding PoolsStatusText}" VerticalAlignment="Center" Foreground="Gray"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                            <TextBox Width="210" Text="{Binding PoolSearch, UpdateSourceTrigger=PropertyChanged}" ToolTip="Search pools by name or ID"/>
                            <Button Content="Filter" Margin="6,0,0,0" Command="{Binding RunPoolsFilterCommand}"/>
                        </StackPanel>
                        <ListBox x:Name="poolsList"
                                 ItemsSource="{Binding FilteredPools}"
                                 SelectedItem="{Binding SelectedPool}"
                                 ScrollViewer.VerticalScrollBarVisibility="Auto"
                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                 MaxHeight="150"
                                 SelectionChanged="PoolsList_SelectionChanged"
                                 PreviewMouseLeftButtonUp="PoolsList_MouseUp"
                                 KeyDown="PoolsList_KeyDown">
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="Height" Value="22"/>
                                </Style>
                            </ListBox.ItemContainerStyle>
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Margin="0,1,10,1">
                                        <TextBlock Text="{Binding Id}" Width="60" Foreground="Gray"/>
                                        <TextBlock Text="{Binding Name}" TextTrimming="CharacterEllipsis" Width="170"/>
                                        <TextBlock Text="{Binding PostCount}" Width="40" HorizontalAlignment="Right" Foreground="Gray"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                        <Separator Margin="0,6,0,10"/>

                        <TextBlock Text="Include Tags" Style="{StaticResource SubHeaderTextStyle}"/>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                            <TextBox x:Name="includeTagInput" Width="160" KeyDown="TagEditor_KeyDown"/>
                            <Button Content="Add" Margin="6,0,0,0" Click="AddIncludeTag_Click"/>
                        </StackPanel>
                        
                        <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="130">
                        <ItemsControl ItemsSource="{Binding IncludeTags}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Margin="0,1">
                                        <Button Content="{Binding}" Style="{StaticResource TagButtonStyle}" 
                                                Background="LightGreen" Foreground="Black"/>
                                        <Button Content="×" Width="16" Height="16" FontSize="10" 
                                                Command="{Binding DataContext.RemoveIncludeTagCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}" Background="Red" Foreground="White" Margin="2,0,0,0"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        </ScrollViewer>

                        <TextBlock Text="Exclude Tags" Style="{StaticResource SubHeaderTextStyle}" Margin="0,15,0,0"/>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                            <TextBox x:Name="excludeTagInput" Width="160" KeyDown="TagEditorExclude_KeyDown"/>
                            <Button Content="Add" Margin="6,0,0,0" Click="AddExcludeTag_Click"/>
                        </StackPanel>
                        <!-- Move Exclude tags list above Saved Searches -->
                        <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="130">
                        <ItemsControl ItemsSource="{Binding ExcludeTags}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Margin="0,1">
                                        <Button Content="{Binding}" Style="{StaticResource TagButtonStyle}" 
                                                Background="LightCoral" Foreground="Black"/>
                                        <Button Content="×" Width="16" Height="16" FontSize="10" 
                                                Command="{Binding DataContext.RemoveExcludeTagCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}" Background="Red" Foreground="White" Margin="2,0,0,0"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        </ScrollViewer>

                        <TextBlock Text="Saved Searches" Style="{StaticResource SubHeaderTextStyle}" Margin="0,15,0,0"/>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                            <TextBox Width="160" Text="{Binding SaveSearchName, UpdateSourceTrigger=PropertyChanged}"/>
                            <Button Content="Save" Margin="6,0,0,0" Command="{Binding SaveSearchCommand}"/>
                        </StackPanel>
                        <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="130">
                        <ItemsControl ItemsSource="{Binding SavedSearches}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                        <TextBlock Text="{Binding Name}" Width="130" TextTrimming="CharacterEllipsis"/>
                                        <Button Content="Search" Margin="6,0,0,0"
                                                Command="{Binding DataContext.ApplySavedSearchCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}"/>
                                        <Button Content="Delete" Margin="6,0,0,0"
                                                Command="{Binding DataContext.DeleteSavedSearchCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        </ScrollViewer>
                        
                    </StackPanel>
                </ScrollViewer>
            </Border>

            <!-- Gallery Grid with Loading Overlay -->
            <Grid Grid.Column="1">
                <ListView x:Name="galleryListView" ItemsSource="{Binding SearchResults}"
                          SelectedItem="{Binding SelectedMedia}" BorderThickness="0"
                          ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                          ScrollViewer.VerticalScrollBarVisibility="Auto">
                    <ListView.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal" />
                        </ItemsPanelTemplate>
                    </ListView.ItemsPanel>
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Margin" Value="0"/>
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="VerticalContentAlignment" Value="Stretch"/>
                        </Style>
                    </ListView.ItemContainerStyle>
                    <ListView.ItemTemplate>
                        <DataTemplate>
                <Border Width="{Binding DataContext.GalleryTileWidth, RelativeSource={RelativeSource AncestorType=Window}}"
                    Height="{Binding DataContext.GalleryTileHeight, RelativeSource={RelativeSource AncestorType=Window}}"
                    Margin="5" BorderBrush="Gray" BorderThickness="1">
                                <StackPanel>
                    <Image Source="{Binding PreviewUrl, Converter={StaticResource ImageCacheConverter}}"
                       Width="{Binding DataContext.GalleryImageSize, RelativeSource={RelativeSource AncestorType=Window}}"
                       Height="{Binding DataContext.GalleryImageSize, RelativeSource={RelativeSource AncestorType=Window}}"
                       Stretch="UniformToFill"/>
                                    <Grid Margin="2,0,2,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <StackPanel Grid.Row="0" Grid.Column="0">
                                            <TextBlock Text="{Binding Title}" FontSize="10" TextTrimming="CharacterEllipsis" ToolTip="{Binding Title}"/>
                                            <TextBlock Text="{Binding Artist}" FontSize="9" Foreground="Gray" TextTrimming="CharacterEllipsis"/>
                                        </StackPanel>
                                        <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Top" Margin="6,0,0,0">
                                            <TextBlock Text="✔" Foreground="Green" FontWeight="Bold" Margin="0,0,4,0">
                                                <TextBlock.Visibility>
                                                    <Binding Converter="{StaticResource IsMediaDownloadedConverter}"/>
                                                </TextBlock.Visibility>
                                            </TextBlock>
                                            <TextBlock Text="{Binding FileExtension, Converter={StaticResource UppercaseConverter}}" 
                                                       FontSize="12" FontWeight="Bold" Foreground="DimGray"/>
                                        </StackPanel>
                                        <!-- Row 1 now free for other details; removed ID row per request -->
                                    </Grid>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>

                <!-- Loading Overlay -->
                <Border Background="#80000000" Visibility="{Binding IsSearching, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Grid>
                        <TextBlock Text="Loading..." Foreground="White" FontSize="20" FontWeight="SemiBold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Grid>
                </Border>
            </Grid>

            <!-- Preview Pane -->
        <Border Grid.Column="2" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" 
                    BorderBrush="{DynamicResource SystemControlBackgroundBaseMediumBrush}" BorderThickness="1,0,0,0">
                <ScrollViewer Margin="10" DataContext="{Binding SelectedMedia}">
                    <StackPanel>
                        <ContentControl x:Name="previewPane">
                            <StackPanel>
                <!-- Actions moved above preview image (now side-by-side) -->
                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                    <Button Content="Open Viewer" Click="OpenViewer_Click"
                        IsEnabled="{Binding Id, Converter={StaticResource NullToBooleanConverter}}"/>
                    <Button Content="Open in Browser" Margin="6,0,0,0" Click="OpenInBrowser_Click"
                        IsEnabled="{Binding SourceUrl, Converter={StaticResource NullToBooleanConverter}}"/>
                </StackPanel>
                                <!-- Preview Image (click to open viewer) -->
                                <Image Source="{Binding PreviewUrl, Converter={StaticResource ImageCacheConverter}}" MaxHeight="300" Stretch="Uniform" Margin="0,0,0,10" MouseLeftButtonUp="OpenViewer_Click" Cursor="Hand"/>
                                
                                <!-- Media Info -->
                                <TextBlock Text="{Binding Title}" Style="{StaticResource SubHeaderTextStyle}" TextWrapping="Wrap"/>
                                <TextBlock Text="{Binding Artist}" FontStyle="Italic" Margin="0,0,0,5"/>
                                <TextBlock Text="{Binding Source}" FontSize="10" Foreground="Gray" Margin="0,0,0,5"/>
                                
                                <!-- Description -->
                                <TextBlock Text="Description:" FontWeight="SemiBold" Margin="0,10,0,5"/>
                                <TextBlock Text="{Binding Description}" TextWrapping="Wrap" Margin="0,0,0,10"/>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <TextBlock Text="✔" Foreground="Green" FontWeight="Bold">
                                        <TextBlock.Visibility>
                                            <Binding Path="DataContext.IsSelectedDownloaded" RelativeSource="{RelativeSource AncestorType=Window}" Converter="{StaticResource BooleanToVisibilityConverter}"/>
                                        </TextBlock.Visibility>
                                    </TextBlock>
                                    <TextBlock Text="Downloaded" Foreground="Green" FontWeight="SemiBold" Margin="6,0,0,0">
                                        <TextBlock.Visibility>
                                            <Binding Path="DataContext.IsSelectedDownloaded" RelativeSource="{RelativeSource AncestorType=Window}" Converter="{StaticResource BooleanToVisibilityConverter}"/>
                                        </TextBlock.Visibility>
                                    </TextBlock>
                                </StackPanel>
                                
                                <!-- Tags grouped by category with fixed-height scroll per section -->
                                <TextBlock Text="Tags:" FontWeight="SemiBold" Margin="0,0,0,5"/>
                                <ItemsControl ItemsSource="{Binding TagCategories, Converter={StaticResource FilterAndOrderCategoriesConverter}}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Margin="0,4,0,6">
                                                <TextBlock Text="{Binding Key, Converter={StaticResource CategoryKeyToHeaderConverter}}" FontWeight="SemiBold" FontSize="12"/>
                                                <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="100">
                                                    <ItemsControl ItemsSource="{Binding Value}">
                                                        <ItemsControl.ItemsPanel>
                                                            <ItemsPanelTemplate>
                                                                <WrapPanel/>
                                                            </ItemsPanelTemplate>
                                                        </ItemsControl.ItemsPanel>
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate>
                                                                <Button Content="{Binding}" Margin="2,1"
                                                                        Command="{Binding DataContext.AddIncludeTagCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                        CommandParameter="{Binding}">
                                                                    <Button.Style>
                                                                        <Style TargetType="Button" BasedOn="{StaticResource TagButtonStyle}">
                                                                            <Setter Property="FontWeight" Value="Normal"/>
                                                                            <Setter Property="Foreground" Value="{Binding Path=DataContext.Key, Converter={StaticResource CategoryToBrushConverter}, RelativeSource={RelativeSource AncestorType=ItemsControl}}"/>
                                                                            <Setter Property="BorderBrush" Value="{Binding Path=DataContext.Key, Converter={StaticResource CategoryToBrushConverter}, RelativeSource={RelativeSource AncestorType=ItemsControl}}"/>
                                                                            <Setter Property="BorderThickness" Value="1"/>
                                                                            <Style.Triggers>
                                                                                <DataTrigger Value="True">
                                                                                    <DataTrigger.Binding>
                                                                                        <MultiBinding Converter="{StaticResource StringEqualsConverter}" ConverterCulture="en-US" Mode="OneWay">
                                                                                            <Binding Path="."/>
                                                                                            <Binding Path="DataContext.Artist" RelativeSource="{RelativeSource AncestorType=ItemsControl}"/>
                                                                                        </MultiBinding>
                                                                                    </DataTrigger.Binding>
                                                                                    <Setter Property="FontWeight" Value="Bold"/>
                                                                                    <Setter Property="Background" Value="#10FFD700"/>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </Button.Style>
                                                                    <Button.InputBindings>
                                                                        <MouseBinding Gesture="RightClick"
                                                                                      Command="{Binding DataContext.AddExcludeTagCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                                      CommandParameter="{Binding}"/>
                                                                    </Button.InputBindings>
                                                                </Button>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>
                                                </ScrollViewer>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                
                                <!-- Metadata -->
                                <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                                    <TextBlock Text="Score: " FontSize="10"/>
                                    <TextBlock Text="{Binding Score}" FontSize="10"/>
                                    <TextBlock Text=" | Favs: " FontSize="10" Margin="10,0,0,0"/>
                                    <TextBlock Text="{Binding FavoriteCount}" FontSize="10"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Size: " FontSize="10"/>
                                    <TextBlock Text="{Binding Width}" FontSize="10"/>
                                    <TextBlock Text="×" FontSize="10"/>
                                    <TextBlock Text="{Binding Height}" FontSize="10"/>
                                </StackPanel>

                <!-- Action buttons moved above -->
                            </StackPanel>
                        </ContentControl>
                    </StackPanel>
                </ScrollViewer>
            </Border>

        <!-- Resizers -->
    <GridSplitter Grid.Column="0" HorizontalAlignment="Right" VerticalAlignment="Stretch" Width="5" Background="Transparent" ShowsPreview="True" ResizeDirection="Columns" DragCompleted="ColumnSplitter_DragCompleted"/>
    <GridSplitter Grid.Column="1" HorizontalAlignment="Right" VerticalAlignment="Stretch" Width="5" Background="Transparent" ShowsPreview="True" ResizeDirection="Columns" DragCompleted="ColumnSplitter_DragCompleted"/>
        </Grid>

    <!-- Horizontal Splitter between main content and downloads -->
    <GridSplitter Grid.Row="2" Height="5" HorizontalAlignment="Stretch" VerticalAlignment="Center"
              Background="Transparent" ShowsPreview="True" ResizeDirection="Rows" DragCompleted="RowSplitter_DragCompleted"/>

    <!-- Download Queue -->
    <Border Grid.Row="3" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" 
                BorderBrush="{DynamicResource SystemControlBackgroundBaseMediumBrush}" BorderThickness="0,1,0,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
        <StackPanel Grid.Row="0" Orientation="Horizontal" Background="{DynamicResource SystemControlBackgroundBaseMediumBrush}" Margin="5">
            <TextBlock Text="Downloads" Style="{StaticResource SubHeaderTextStyle}" VerticalAlignment="Center"/>
            <StackPanel Orientation="Horizontal" Margin="10,0,0,0">
            <Button x:Name="downloadButton" Content="Download" Command="{Binding DownloadSelectedCommand}"
                Style="{StaticResource ToolbarButtonStyle}" IsEnabled="{Binding SelectedMedia, Converter={StaticResource NullToBooleanConverter}}"/>
            <Button x:Name="downloadAllButton" Content="{Binding DownloadAllLabel}" Command="{Binding DownloadAllCommand}"
                Style="{StaticResource ToolbarButtonStyle}" Margin="6,0,0,0"/>
            <Button x:Name="openDownloadsButton" Content="Open Downloads" Click="OpenDownloads_Click"
                Style="{StaticResource ToolbarButtonStyle}" Margin="6,0,0,0"/>
            </StackPanel>
        </StackPanel>

                <ListView Grid.Row="1" x:Name="downloadQueue" ItemsSource="{Binding DownloadQueue}" BorderThickness="0">
                    <ListView.View>
                        <GridView>
                            <GridViewColumn Width="220">
                                <GridViewColumn.Header>
                                    <GridViewColumnHeader Content="Title" Tag="MediaItem.Title" Click="DownloadGridHeader_Click"/>
                                </GridViewColumn.Header>
                                <GridViewColumn.DisplayMemberBinding>
                                    <Binding Path="MediaItem.Title"/>
                                </GridViewColumn.DisplayMemberBinding>
                            </GridViewColumn>
                            <GridViewColumn Width="100">
                                <GridViewColumn.Header>
                                    <GridViewColumnHeader Content="Status" Tag="Status" Click="DownloadGridHeader_Click"/>
                                </GridViewColumn.Header>
                                <GridViewColumn.DisplayMemberBinding>
                                    <Binding Path="Status"/>
                                </GridViewColumn.DisplayMemberBinding>
                            </GridViewColumn>
                            <GridViewColumn Width="180">
                                <GridViewColumn.Header>
                                    <GridViewColumnHeader Content="Progress" Tag="ProgressPercent" Click="DownloadGridHeader_Click"/>
                                </GridViewColumn.Header>
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <ProgressBar Value="{Binding ProgressPercent, Mode=OneWay}" Height="16" Width="110"/>
                                            <TextBlock Text="{Binding ProgressPercent, StringFormat={}{0:0}%}" Margin="6,0,0,0" Width="40"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            <GridViewColumn Width="140">
                                <GridViewColumn.Header>
                                    <GridViewColumnHeader Content="Size" Tag="TotalBytes" Click="DownloadGridHeader_Click"/>
                                </GridViewColumn.Header>
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding TotalBytes, Converter={StaticResource BytesToStringConverter}}"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            <GridViewColumn Header="Path" Width="360">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding DestinationPath}" TextTrimming="CharacterEllipsis" ToolTip="{Binding DestinationPath}"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            <GridViewColumn Header="Actions" Width="140">
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                                            <Button Content="Open" Width="56" Margin="0,0,6,0" Click="OpenDownloadedFile_Click"/>
                                            <Button Content="Folder" Width="60" Click="OpenDownloadedFolder_Click"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            <GridViewColumn Header="Error" DisplayMemberBinding="{Binding ErrorMessage}" Width="200"/>
                        </GridView>
                    </ListView.View>
                </ListView>
            </Grid>
        </Border>

        <!-- Status Bar -->
    <StatusBar Grid.Row="4" x:Name="statusBar" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}"/>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Health: " Margin="0,0,5,0"/>
                    <!-- Platform health indicators would go here -->
                </StackPanel>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
