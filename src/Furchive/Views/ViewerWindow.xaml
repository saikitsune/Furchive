<Window x:Class="Furchive.Views.ViewerWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ui="http://schemas.modernwpf.com/2019"
    xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
    xmlns:local="clr-namespace:Furchive.Converters"
    Title="Viewer" Height="1000" Width="1700" MinWidth="900" MinHeight="360"
        ui:WindowHelper.UseModernWindowStyle="True">
    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ui:ThemeResources />
                <ui:XamlControlsResources />
            </ResourceDictionary.MergedDictionaries>
            <local:ImageCacheConverter x:Key="ImageCacheConverter"/>
            <local:FileExtensionToVisibilityConverter x:Key="FileExtToVisibility"/>
        </ResourceDictionary>
    </Window.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <ToolBar Grid.Row="0" ToolBarTray.IsLocked="True" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}">
            <StackPanel Orientation="Horizontal">
                <Button Content="◀ Prev" Click="Prev_Click" Margin="2"/>
                <Button Content="Next ▶" Click="Next_Click" Margin="2"/>
                <TextBlock Text="{Binding Title}" Margin="10,0,0,0" VerticalAlignment="Center"/>
                <Button Content="Open in Browser" Click="OpenInBrowser_Click" Margin="10,0,0,0"/>
                <Button Content="Download" Click="Download_Click" Margin="10,0,0,0"/>
                <Button Content="Open Downloads" Click="OpenDownloads_Click" Margin="10,0,0,0"/>
                <Separator Margin="10,0"/>
                <TextBlock Text="Fit:" VerticalAlignment="Center" Margin="10,0,4,0"/>
                <ComboBox x:Name="fitMode" Width="100" SelectedIndex="0" SelectionChanged="FitMode_SelectionChanged">
                    <ComboBoxItem Content="Contain"/>
                    <ComboBoxItem Content="Fill"/>
                    <ComboBoxItem Content="Original"/>
                </ComboBox>
            </StackPanel>
        </ToolBar>

        <Grid Grid.Row="1">
            <ScrollViewer x:Name="contentScrollViewer" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                <!-- Bind inner container to the viewport to allow Viewbox to scale down when the window is smaller -->
                <Grid Width="{Binding ElementName=contentScrollViewer, Path=ViewportWidth}"
                      Height="{Binding ElementName=contentScrollViewer, Path=ViewportHeight}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                        <!-- Image/GIF -->
                        <Viewbox x:Name="imageBox" Stretch="Uniform" Visibility="{Binding FileExtension, Converter={StaticResource FileExtToVisibility}, ConverterParameter=image}">
                            <Image x:Name="imageViewer"/>
                        </Viewbox>

                    <!-- Video via WebView2 only -->
                    <Grid>
                        <wv2:WebView2 x:Name="webView" Visibility="Collapsed" HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                    </Grid>

                    <!-- SWF placeholder: prompt to open in browser or external player -->
                    <Border Visibility="{Binding FileExtension, Converter={StaticResource FileExtToVisibility}, ConverterParameter=swf}"
                            Background="#22000000" Padding="20">
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                            <TextBlock Text="SWF content not playable inline." HorizontalAlignment="Center"/>
                            <Button Content="Open in Browser" Click="OpenInBrowser_Click" Margin="0,10,0,0" Width="160"/>
                        </StackPanel>
                    </Border>
                </Grid>
            </ScrollViewer>

            <!-- Loading overlay -->
            <Border x:Name="loadingOverlay" Background="#B3000000" Visibility="Collapsed">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <TextBlock x:Name="loadingText" Text="Loading..." Foreground="White" FontSize="20" HorizontalAlignment="Center"/>
                    <ProgressBar x:Name="loadingProgress" Width="360" Height="16" Margin="0,10,0,0" Minimum="0" Maximum="100"/>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</Window>
