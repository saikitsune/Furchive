<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="using:Avalonia.Controls"
        xmlns:sys="clr-namespace:System;assembly=System.Runtime"
        x:Class="Furchive.Avalonia.Views.SettingsWindow"
        Width="900" Height="640" Title="Settings"
        Icon="avares://Furchive/Assets/icon.ico">
    <Window.Resources>
        <sys:String x:Key="FilenameTokens">Available tokens: {source}, {artist}, {id}, {safeTitle}, {ext}, {pool_name}, {page_number}</sys:String>
    </Window.Resources>
    <Grid RowDefinitions="Auto,Auto,*,Auto" Margin="12">
        <TextBlock Text="Settings" FontSize="20"/>
        <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
            <Button Content="Save" Click="OnSave"/>
            <Button Content="Close" Click="OnClose"/>
        </StackPanel>
        <TabControl Grid.Row="2">
            <!-- Download Tab -->
            <TabItem Header="Download">
                <ScrollViewer>
                    <StackPanel Spacing="12" Margin="0,8,0,0">
                        <StackPanel>
                            <TextBlock Text="Default Download Directory"/>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBox x:Name="DownloadDir" Width="600"/>
                                <Button Content="Browse…" Click="OnBrowseDownloadDir"/>
                            </StackPanel>
                        </StackPanel>
                        <Separator/>
                        <TextBlock Text="Filename Templates" FontWeight="SemiBold"/>
                        <TextBlock Text="{StaticResource FilenameTokens}" FontStyle="Italic"/>
                        <StackPanel>
                            <TextBlock Text="Single Post"/>
                            <TextBox x:Name="FilenameTemplate"/>
                        </StackPanel>
                        <StackPanel>
                            <TextBlock Text="Pool Post"/>
                            <TextBox x:Name="PoolFilenameTemplate"/>
                        </StackPanel>
                        <Separator/>
                        <TextBlock Text="Download Behaviour" FontWeight="SemiBold"/>
                        <StackPanel Orientation="Horizontal" Spacing="16">
                            <StackPanel Width="160">
                                <TextBlock Text="Concurrent Downloads"/>
                                <controls:NumericUpDown x:Name="ConcurrentDownloads" Minimum="1" Maximum="8"/>
                            </StackPanel>
                            <StackPanel Width="200">
                                <TextBlock Text="Duplicate Policy (skip|overwrite)"/>
                                <TextBox x:Name="DownloadDuplicatesPolicy" Width="180"/>
                            </StackPanel>
                            <StackPanel VerticalAlignment="Center" Spacing="4">
                                <CheckBox x:Name="SaveMetadataJson" Content="Save metadata json"/>
                                <CheckBox x:Name="UseOriginalFilename" Content="Use original filename if available"/>
                                <CheckBox x:Name="SavePostJson" Content="Save per-post json"/>
                            </StackPanel>
                        </StackPanel>
                        <Separator/>
                        <TextBlock Text="e621 Credentials" FontWeight="SemiBold"/>
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <StackPanel Width="220">
                                <TextBlock Text="Username"/>
                                <TextBox x:Name="E621User"/>
                            </StackPanel>
                            <StackPanel Width="300">
                                <TextBlock Text="API Key"/>
                                <TextBox x:Name="E621Key"/>
                            </StackPanel>
                            <StackPanel Width="300">
                                <TextBlock Text="User-Agent"/>
                                <TextBox x:Name="ComputedUserAgent" IsReadOnly="True"/>
                            </StackPanel>
                            <Button Content="Authenticate" VerticalAlignment="Bottom" Click="OnAuthenticateE621"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
            <!-- Performance Tab -->
            <TabItem Header="Performance">
                <ScrollViewer>
                    <StackPanel Spacing="12" Margin="0,8,0,0">
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <StackPanel Width="180">
                                <TextBlock Text="Network Timeout (sec)"/>
                                <controls:NumericUpDown x:Name="NetworkTimeoutSeconds" Minimum="5" Maximum="120"/>
                            </StackPanel>
                            <StackPanel Width="200">
                                <TextBlock Text="Max Results Per Source"/>
                                <controls:NumericUpDown x:Name="MaxResultsPerSource" Minimum="10" Maximum="320" Increment="10" ValueChanged="OnMaxResultsPerSourceChanged"/>
                            </StackPanel>
                            <StackPanel Width="200">
                                <TextBlock Text="Prefetch Pages Ahead"/>
                                <controls:NumericUpDown x:Name="PrefetchPagesAhead" Minimum="0" Maximum="10"/>
                            </StackPanel>
                            <StackPanel Width="200">
                                <TextBlock Text="Prefetch Parallelism"/>
                                <controls:NumericUpDown x:Name="PrefetchParallelism" Minimum="1" Maximum="8"/>
                            </StackPanel>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" Spacing="12">
                            <StackPanel Width="200">
                                <TextBlock Text="CPU Worker Degree"/>
                                <controls:NumericUpDown x:Name="CpuWorkerDegree" Minimum="1" Maximum="64"/>
                            </StackPanel>
                            <StackPanel VerticalAlignment="Center">
                                <CheckBox x:Name="ThumbnailPrewarmEnabled" Content="Prewarm thumbnails in background"/>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
            <!-- Appearance Tab -->
            <TabItem Header="Appearance">
                <ScrollViewer>
                    <StackPanel Spacing="12" Margin="0,8,0,0">
                        <TextBlock Text="Appearance" FontWeight="SemiBold"/>
                        <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                            <TextBlock Text="Gallery item scale" Width="160" VerticalAlignment="Center"/>
                            <Slider x:Name="GalleryScale" Minimum="0.5" Maximum="2.0" TickFrequency="0.05" Width="220"/>
                            <TextBlock Text="x"/>
                            <TextBox x:Name="GalleryScaleText" Width="60" HorizontalContentAlignment="Right" ToolTip.Tip="0.50 – 2.00" LostFocus="OnGalleryScaleTextLostFocus" KeyDown="OnGalleryScaleTextKeyDown"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                            <TextBlock Text="Posts per page" Width="160" VerticalAlignment="Center"/>
                            <controls:NumericUpDown x:Name="PostsPerPage" Minimum="10" Maximum="320" Increment="10" Width="120" ValueChanged="OnPostsPerPageChanged"/>
                        </StackPanel>
                        <CheckBox x:Name="LoadLastSessionEnabled" Content="Load last session on startup"/>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
            <!-- Cache Tab -->
            <TabItem Header="Cache">
                <ScrollViewer>
                    <StackPanel Spacing="12" Margin="0,8,0,0">
                        <TextBlock Text="Logging" FontWeight="SemiBold"/>
                        <CheckBox x:Name="DebugLoggingEnabled" Content="Enable debug logging (requires restart)"/>
                        <Separator/>
                        <TextBlock Text="Cache" FontWeight="SemiBold"/>
                        <StackPanel>
                            <TextBlock Text="Cache path"/>
                            <TextBox x:Name="CachePath" IsReadOnly="True" Width="600"/>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="Used:"/>
                                <TextBlock x:Name="CacheUsed"/>
                                <Button Content="Refresh" Click="OnRefreshCacheInfo"/>
                                <Button Content="Clear" Click="OnClearCache"/>
                                <Button Content="Open" Click="OnOpenCacheFolder"/>
                            </StackPanel>
                        </StackPanel>
                        <Separator/>
                        <TextBlock Text="Temp" FontWeight="SemiBold"/>
                        <StackPanel>
                            <TextBlock Text="Temp path"/>
                            <TextBox x:Name="TempPath" IsReadOnly="True" Width="600"/>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="Used:"/>
                                <TextBlock x:Name="TempUsed"/>
                                <Button Content="Refresh" Click="OnRefreshTempInfo"/>
                                <Button Content="Clear" Click="OnClearTemp"/>
                                <Button Content="Open" Click="OnOpenTempFolder"/>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
            <!-- e621 Cache Tab (simplified) -->
            <TabItem Header="e621 Cache">
                <ScrollViewer>
                    <StackPanel Spacing="12" Margin="0,8,0,0">
                        <!-- Per requirement: removed Clear Caches buttons UI -->
                        <Separator/>
                        <TextBlock Text="Pools" FontWeight="SemiBold"/>
                        <StackPanel Orientation="Horizontal" Spacing="24">
                            <StackPanel Width="220">
                                <TextBlock Text="Update Interval (minutes)"/>
                                <controls:NumericUpDown x:Name="PoolsUpdateIntervalMinutes" Minimum="5" Maximum="1440"/>
                            </StackPanel>
                            <StackPanel>
                                <TextBlock Text="Pools cache database"/>
                                <TextBox x:Name="PoolsCacheFilePath" IsReadOnly="True" Width="600"/>
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <TextBlock Text="Cached pools:"/>
                                    <TextBlock x:Name="PoolsCachedCount"/>
                                    <TextBlock Text="Last updated:" Margin="12,0,0,0"/>
                                    <TextBlock x:Name="PoolsLastCachedAt"/>
                                    <Button Content="Refresh Info" Click="OnRefreshPoolsCacheInfo"/>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button Content="Check Updates" Click="OnSoftRefreshPools"/>
                            <Button Content="Rebuild Pools Cache" Click="OnRebuildPoolsCache"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>
        <StackPanel Grid.Row="3" Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" Margin="0,8,0,0">
            <Button Content="Save" Click="OnSave"/>
            <Button Content="Close" Click="OnClose"/>
        </StackPanel>
    </Grid>
</Window>
